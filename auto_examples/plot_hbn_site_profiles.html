<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Harmonize HBN data using ComBat &mdash; AFQ-Insight 0.3.4 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/afqinsight.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Predict age from white matter features" href="plot_age_regression.html" />
    <link rel="prev" title="Load and interact with an AFQ dataset" href="demo_afq_dataset.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> AFQ-Insight
          </a>
              <div class="version">
                0.3.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">User guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">General examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="demo_afq_dataset.html">Load and interact with an AFQ dataset</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Harmonize HBN data using ComBat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fetch-the-hbn-data">Fetch the HBN data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#train-test-split">Train / test split</a></li>
<li class="toctree-l3"><a class="reference internal" href="#impute-missing-values">Impute missing values</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plot-average-bundle-profiles-by-scan-site">Plot average bundle profiles by scan site</a></li>
<li class="toctree-l3"><a class="reference internal" href="#harmonize-the-sites-and-replot">Harmonize the sites and replot</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="plot_age_regression.html">Predict age from white matter features</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_als_classification.html">Classify ALS diagnosis from white matter features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help.html">Getting help using <em>AFQ-Insight</em></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to <em>AFQ-Insight</em></a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/AFQ-Insight">AFQ-Insight on GitHub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AFQ-Insight</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">General examples</a> &raquo;</li>
      <li>Harmonize HBN data using ComBat</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/auto_examples/plot_hbn_site_profiles.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-plot-hbn-site-profiles-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="harmonize-hbn-data-using-combat">
<span id="sphx-glr-auto-examples-plot-hbn-site-profiles-py"></span><h1>Harmonize HBN data using ComBat<a class="headerlink" href="#harmonize-hbn-data-using-combat" title="Permalink to this headline"></a></h1>
<p>This example loads AFQ data from the Healthy Brain Network (HBN) preprocessed
diffusion derivatives <a class="footnote-reference brackets" href="#id3" id="id1">1</a>. The HBN is a landmark pediatric mental health study.
Over the course of the study, it will collect diffusion MRI data from
approximately 5,000 children and adolescents. We recently processed the
available data from over 2,000 of these subjects, and provide the tract profiles
from this dataset, which can be downloaded from AWS thanks to
[INDI](<a class="reference external" href="http://fcon_1000.projects.nitrc.org/">http://fcon_1000.projects.nitrc.org/</a>).</p>
<p>We first load the data by using the <code class="xref py py-func docutils literal notranslate"><span class="pre">AFQDataset.from_files()</span></code> static method
and supplying AWS S3 URIs instead of local file names. We then impute missing
values and plot the mean bundle profiles by scanning site, noting that there are
substantial site differences. Lastly, we harmonize the site differences using
NeuroComBat <a class="footnote-reference brackets" href="#id4" id="id2">2</a> and plot the harmonized bundle profiles to verify that the site
differences have been removed.</p>
<dl class="footnote brackets">
<dt class="label" id="id3"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Adam Richie-Halford, Matthew Cieslak, Lei Ai, Sendy Caffarra, Sydney
Covitz, Alexandre R. Franco, Iliana I. Karipidis, John Kruper, Michael
Milham, Bárbara Avelar-Pereira, Ethan Roy, Valerie J. Sydnor, Jason Yeatman,
The Fibr Community Science Consortium, Theodore D. Satterthwaite, and Ariel
Rokem,
“An open, analysis-ready, and quality controlled resource for pediatric brain
white-matter research”
bioRxiv 2022.02.24.481303;
doi: <a class="reference external" href="https://doi.org/10.1101/2022.02.24.481303">https://doi.org/10.1101/2022.02.24.481303</a></p>
</dd>
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Jean-Philippe Fortin, Drew Parker, Birkan Tunc, Takanori Watanabe, Mark A
Elliott, Kosha Ruparel, David R Roalf, Theodore D Satterthwaite, Ruben C Gur,
Raquel E Gur, Robert T Schultz, Ragini Verma, Russell T Shinohara.
“Harmonization Of Multi-Site Diffusion Tensor Imaging Data”
NeuroImage, 161, 149-170, 2017;
doi: <a class="reference external" href="https://doi.org/10.1016/j.neuroimage.2017.08.047">https://doi.org/10.1016/j.neuroimage.2017.08.047</a></p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">afqinsight</span> <span class="kn">import</span> <span class="n">AFQDataset</span>
<span class="kn">from</span> <span class="nn">afqinsight.plot</span> <span class="kn">import</span> <span class="n">plot_tract_profiles</span>
<span class="kn">from</span> <span class="nn">neurocombat_sklearn</span> <span class="kn">import</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.BaseEstimator.html#sklearn.base.BaseEstimator" title="sklearn.base.BaseEstimator" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">CombatModel</span></a>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.SimpleImputer.html#sklearn.impute.SimpleImputer" title="sklearn.impute.SimpleImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><span class="n">SimpleImputer</span></a>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html#sklearn.model_selection.train_test_split" title="sklearn.model_selection.train_test_split" class="sphx-glr-backref-module-sklearn-model_selection sphx-glr-backref-type-py-function"><span class="n">train_test_split</span></a>
</pre></div>
</div>
<section id="fetch-the-hbn-data">
<h2>Fetch the HBN data<a class="headerlink" href="#fetch-the-hbn-data" title="Permalink to this headline"></a></h2>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">AFQDataset.from_files()</span></code> static method expects a path to
nodes.csv and subjects.csv files, but these file paths can be remote
URLs or AWS S3 URIs. We’ll use S3 URIs to grab the HBN data. After dropping
participants with null phenotypic values, it has 1,867 participants.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset</span></a> <span class="o">=</span> <span class="n">AFQDataset</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span>
    <span class="n">fn_nodes</span><span class="o">=</span><span class="s2">&quot;s3://fcp-indi/data/Projects/HBN/BIDS_curated/derivatives/afq/combined_tract_profiles.csv&quot;</span><span class="p">,</span>
    <span class="n">fn_subjects</span><span class="o">=</span><span class="s2">&quot;s3://fcp-indi/data/Projects/HBN/BIDS_curated/derivatives/qsiprep/participants.tsv&quot;</span><span class="p">,</span>
    <span class="n">dwi_metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dki_fa&quot;</span><span class="p">,</span> <span class="s2">&quot;dki_md&quot;</span><span class="p">],</span>
    <span class="n">target_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_site_id&quot;</span><span class="p">],</span>
    <span class="n">label_encode_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_site_id&quot;</span><span class="p">],</span>
    <span class="n">index_col</span><span class="o">=</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span>
<span class="p">)</span>
<a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset</span></a><span class="o">.</span><span class="n">drop_target_na</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset</span></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>AFQDataset(n_samples=1867, n_features=4800, n_targets=3, targets=[&#39;age&#39;, &#39;sex&#39;, &#39;scan_site_id&#39;])
</pre></div>
</div>
</section>
<section id="train-test-split">
<h2>Train / test split<a class="headerlink" href="#train-test-split" title="Permalink to this headline"></a></h2>
<p>We can use the dataset in the <code class="xref py py-func docutils literal notranslate"><span class="pre">train_test_split()</span></code> function just as we
would with an array.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_train</span></a><span class="p">,</span> <a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span></a> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html#sklearn.model_selection.train_test_split" title="sklearn.model_selection.train_test_split" class="sphx-glr-backref-module-sklearn-model_selection sphx-glr-backref-type-py-function"><span class="n">train_test_split</span></a><span class="p">(</span><a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset</span></a><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="impute-missing-values">
<h2>Impute missing values<a class="headerlink" href="#impute-missing-values" title="Permalink to this headline"></a></h2>
<p>Next we impute missing values using median imputation. We fit the imputer
using the training set and then use it to transform both the training and test
sets.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.SimpleImputer.html#sklearn.impute.SimpleImputer" title="sklearn.impute.SimpleImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imputer</span></a> <span class="o">=</span> <a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_train</span></a><span class="o">.</span><span class="n">model_fit</span><span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.SimpleImputer.html#sklearn.impute.SimpleImputer" title="sklearn.impute.SimpleImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class"><span class="n">SimpleImputer</span></a><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">))</span>
<a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_train</span></a> <span class="o">=</span> <a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_train</span></a><span class="o">.</span><span class="n">model_transform</span><span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.SimpleImputer.html#sklearn.impute.SimpleImputer" title="sklearn.impute.SimpleImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imputer</span></a><span class="p">)</span>
<a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span></a> <span class="o">=</span> <a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span></a><span class="o">.</span><span class="n">model_transform</span><span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.SimpleImputer.html#sklearn.impute.SimpleImputer" title="sklearn.impute.SimpleImputer" class="sphx-glr-backref-module-sklearn-impute sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imputer</span></a><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="plot-average-bundle-profiles-by-scan-site">
<h2>Plot average bundle profiles by scan site<a class="headerlink" href="#plot-average-bundle-profiles-by-scan-site" title="Permalink to this headline"></a></h2>
<p>Next we plot the mean bundle profiles in the test set by scanning site. The
<code class="xref py py-func docutils literal notranslate"><span class="pre">plot_tract_profiles()</span></code> function takes as input an <code class="xref py py-class docutils literal notranslate"><span class="pre">AFQDataset</span></code> and
returns matplotlib figures displaying the mean bundle profile for each bundle
and metric, optionally grouped by a categorical or continuous variable.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">site_figs</span></a> <span class="o">=</span> <span class="n">plot_tract_profiles</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span></a><span class="p">,</span>
    <span class="n">group_by</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span><span class="o">.</span><span class="n">classes</span></a><span class="p">[</span><span class="s2">&quot;scan_site_id&quot;</span><span class="p">][</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span><span class="o">.</span><span class="n">y</span></a><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span>
    <span class="n">group_by_name</span><span class="o">=</span><span class="s2">&quot;Site&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img src="../_images/sphx_glr_plot_hbn_site_profiles_001.png" srcset="../_images/sphx_glr_plot_hbn_site_profiles_001.png" alt="IFOL, UNCL, UNCR, IFOR, ATRL, CSTL, CSTR, ATRR, ARCL, SLFL, SLFR, ARCR, ILFL, CGCL, CGCR, ILFR, Orbital, AntFrontal, SupFrontal, Motor, SupParietal, Temporal, PostParietal, Occipital" class = "sphx-glr-multi-img"/></li>
<li><img src="../_images/sphx_glr_plot_hbn_site_profiles_002.png" srcset="../_images/sphx_glr_plot_hbn_site_profiles_002.png" alt="IFOL, UNCL, UNCR, IFOR, ATRL, CSTL, CSTR, ATRR, ARCL, SLFL, SLFR, ARCR, ILFL, CGCL, CGCR, ILFR, Orbital, AntFrontal, SupFrontal, Motor, SupParietal, Temporal, PostParietal, Occipital" class = "sphx-glr-multi-img"/></li>
</ul>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/2 [00:00&lt;?, ?it/s]

  0%|          | 0/24 [00:00&lt;?, ?it/s]

  4%|4         | 1/24 [00:05&lt;01:56,  5.07s/it]

  8%|8         | 2/24 [00:10&lt;01:52,  5.13s/it]

 12%|#2        | 3/24 [00:15&lt;01:48,  5.17s/it]

 17%|#6        | 4/24 [00:20&lt;01:41,  5.10s/it]

 21%|##        | 5/24 [00:25&lt;01:37,  5.11s/it]

 25%|##5       | 6/24 [00:30&lt;01:32,  5.14s/it]

 29%|##9       | 7/24 [00:35&lt;01:26,  5.11s/it]

 33%|###3      | 8/24 [00:40&lt;01:20,  5.01s/it]

 38%|###7      | 9/24 [00:45&lt;01:14,  4.96s/it]

 42%|####1     | 10/24 [00:50&lt;01:08,  4.91s/it]

 46%|####5     | 11/24 [00:55&lt;01:03,  4.89s/it]

 50%|#####     | 12/24 [00:59&lt;00:58,  4.87s/it]

 54%|#####4    | 13/24 [01:04&lt;00:53,  4.85s/it]

 58%|#####8    | 14/24 [01:09&lt;00:48,  4.85s/it]

 62%|######2   | 15/24 [01:14&lt;00:43,  4.85s/it]

 67%|######6   | 16/24 [01:19&lt;00:38,  4.85s/it]

 71%|#######   | 17/24 [01:24&lt;00:33,  4.84s/it]

 75%|#######5  | 18/24 [01:28&lt;00:29,  4.84s/it]

 79%|#######9  | 19/24 [01:33&lt;00:24,  4.84s/it]

 83%|########3 | 20/24 [01:38&lt;00:19,  4.82s/it]

 88%|########7 | 21/24 [01:43&lt;00:14,  4.82s/it]

 92%|#########1| 22/24 [01:48&lt;00:09,  4.82s/it]

 96%|#########5| 23/24 [01:53&lt;00:04,  4.82s/it]

100%|##########| 24/24 [01:58&lt;00:00,  4.87s/it]
100%|##########| 24/24 [01:58&lt;00:00,  4.92s/it]

 50%|#####     | 1/2 [01:58&lt;01:58, 118.89s/it]

  0%|          | 0/24 [00:00&lt;?, ?it/s]

  4%|4         | 1/24 [00:04&lt;01:51,  4.84s/it]

  8%|8         | 2/24 [00:09&lt;01:47,  4.91s/it]

 12%|#2        | 3/24 [00:14&lt;01:42,  4.90s/it]

 17%|#6        | 4/24 [00:19&lt;01:37,  4.88s/it]

 21%|##        | 5/24 [00:24&lt;01:32,  4.87s/it]

 25%|##5       | 6/24 [00:29&lt;01:27,  4.84s/it]

 29%|##9       | 7/24 [00:34&lt;01:22,  4.84s/it]

 33%|###3      | 8/24 [00:38&lt;01:17,  4.84s/it]

 38%|###7      | 9/24 [00:43&lt;01:12,  4.85s/it]

 42%|####1     | 10/24 [00:48&lt;01:07,  4.85s/it]

 46%|####5     | 11/24 [00:53&lt;01:03,  4.86s/it]

 50%|#####     | 12/24 [00:58&lt;00:58,  4.88s/it]

 54%|#####4    | 13/24 [01:03&lt;00:53,  4.87s/it]

 58%|#####8    | 14/24 [01:08&lt;00:49,  4.92s/it]

 62%|######2   | 15/24 [01:13&lt;00:44,  4.98s/it]

 67%|######6   | 16/24 [01:18&lt;00:39,  4.95s/it]

 71%|#######   | 17/24 [01:23&lt;00:34,  4.91s/it]

 75%|#######5  | 18/24 [01:27&lt;00:29,  4.89s/it]

 79%|#######9  | 19/24 [01:32&lt;00:24,  4.88s/it]

 83%|########3 | 20/24 [01:37&lt;00:19,  4.89s/it]

 88%|########7 | 21/24 [01:42&lt;00:14,  4.88s/it]

 92%|#########1| 22/24 [01:47&lt;00:09,  4.87s/it]

 96%|#########5| 23/24 [01:52&lt;00:04,  4.87s/it]

100%|##########| 24/24 [01:57&lt;00:00,  4.89s/it]
100%|##########| 24/24 [01:57&lt;00:00,  4.88s/it]

100%|##########| 2/2 [03:57&lt;00:00, 118.49s/it]
100%|##########| 2/2 [03:57&lt;00:00, 118.55s/it]
</pre></div>
</div>
</section>
<section id="harmonize-the-sites-and-replot">
<h2>Harmonize the sites and replot<a class="headerlink" href="#harmonize-the-sites-and-replot" title="Permalink to this headline"></a></h2>
<p>We can see that there are substantial scan site differences in both the
FA and MD profiles. Let’s use neuroComBat to harmonize the site differences
and then replot the mean bundle profiles.</p>
<p>N.B. We use the excellent <a class="reference external" href="https://github.com/Warvito/neurocombat_sklearn">neurocombat_sklearn</a> package to apply ComBat to
our data. We love this library, however it is not fully compliant with the
scikit-learn transformer API, so we cannot use the
<code class="xref py py-func docutils literal notranslate"><span class="pre">AFQDataset.model_fit_transform()</span></code> method to apply this transformer to our
dataset. No problem! We can simply copy the unharmonized dataset into a new
variable and then overwrite the features of the new dataset with the ComBat
output.</p>
<p>Lastly, we replot the mean bundle profiles and confirm that ComBat did its
job.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the ComBat transformer to the training set</span>
<span class="n">combat</span> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.BaseEstimator.html#sklearn.base.BaseEstimator" title="sklearn.base.BaseEstimator" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">CombatModel</span></a><span class="p">()</span>
<span class="n">combat</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_train</span><span class="o">.</span><span class="n">X</span></a><span class="p">,</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_train</span><span class="o">.</span><span class="n">y</span></a><span class="p">[:,</span> <span class="mi">2</span><span class="p">][:,</span> <a href="https://numpy.org/doc/stable/reference/constants.html#numpy.newaxis" title="numpy.newaxis" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-data"><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span></a><span class="p">],</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_train</span><span class="o">.</span><span class="n">y</span></a><span class="p">[:,</span> <span class="mi">1</span><span class="p">][:,</span> <a href="https://numpy.org/doc/stable/reference/constants.html#numpy.newaxis" title="numpy.newaxis" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-data"><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span></a><span class="p">],</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_train</span><span class="o">.</span><span class="n">y</span></a><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <a href="https://numpy.org/doc/stable/reference/constants.html#numpy.newaxis" title="numpy.newaxis" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-data"><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span></a><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># And then transform a copy of the test set</span>
<a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">harmonized_test</span></a> <span class="o">=</span> <a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span></a><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">harmonized_test</span><span class="o">.</span><span class="n">X</span></a> <span class="o">=</span> <span class="n">combat</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span><span class="o">.</span><span class="n">X</span></a><span class="p">,</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span><span class="o">.</span><span class="n">y</span></a><span class="p">[:,</span> <span class="mi">2</span><span class="p">][:,</span> <a href="https://numpy.org/doc/stable/reference/constants.html#numpy.newaxis" title="numpy.newaxis" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-data"><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span></a><span class="p">],</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span><span class="o">.</span><span class="n">y</span></a><span class="p">[:,</span> <span class="mi">1</span><span class="p">][:,</span> <a href="https://numpy.org/doc/stable/reference/constants.html#numpy.newaxis" title="numpy.newaxis" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-data"><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span></a><span class="p">],</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">dataset_test</span><span class="o">.</span><span class="n">y</span></a><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <a href="https://numpy.org/doc/stable/reference/constants.html#numpy.newaxis" title="numpy.newaxis" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-data"><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span></a><span class="p">],</span>
<span class="p">)</span>

<a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">site_figs</span></a> <span class="o">=</span> <span class="n">plot_tract_profiles</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><a href="../api.html#afqinsight.AFQDataset" title="afqinsight.AFQDataset" class="sphx-glr-backref-module-afqinsight sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">harmonized_test</span></a><span class="p">,</span>
    <span class="n">group_by</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">harmonized_test</span><span class="o">.</span><span class="n">classes</span></a><span class="p">[</span><span class="s2">&quot;scan_site_id&quot;</span><span class="p">][</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">harmonized_test</span><span class="o">.</span><span class="n">y</span></a><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">group_by_name</span><span class="o">=</span><span class="s2">&quot;Site&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img src="../_images/sphx_glr_plot_hbn_site_profiles_003.png" srcset="../_images/sphx_glr_plot_hbn_site_profiles_003.png" alt="IFOL, UNCL, UNCR, IFOR, ATRL, CSTL, CSTR, ATRR, ARCL, SLFL, SLFR, ARCR, ILFL, CGCL, CGCR, ILFR, Orbital, AntFrontal, SupFrontal, Motor, SupParietal, Temporal, PostParietal, Occipital" class = "sphx-glr-multi-img"/></li>
<li><img src="../_images/sphx_glr_plot_hbn_site_profiles_004.png" srcset="../_images/sphx_glr_plot_hbn_site_profiles_004.png" alt="IFOL, UNCL, UNCR, IFOR, ATRL, CSTL, CSTR, ATRR, ARCL, SLFL, SLFR, ARCR, ILFL, CGCL, CGCR, ILFR, Orbital, AntFrontal, SupFrontal, Motor, SupParietal, Temporal, PostParietal, Occipital" class = "sphx-glr-multi-img"/></li>
</ul>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/2 [00:00&lt;?, ?it/s]

  0%|          | 0/24 [00:00&lt;?, ?it/s]

  4%|4         | 1/24 [00:04&lt;01:54,  4.99s/it]

  8%|8         | 2/24 [00:09&lt;01:49,  4.96s/it]

 12%|#2        | 3/24 [00:14&lt;01:43,  4.94s/it]

 17%|#6        | 4/24 [00:19&lt;01:38,  4.93s/it]

 21%|##        | 5/24 [00:24&lt;01:34,  4.98s/it]

 25%|##5       | 6/24 [00:29&lt;01:30,  5.01s/it]

 29%|##9       | 7/24 [00:34&lt;01:25,  5.04s/it]

 33%|###3      | 8/24 [00:40&lt;01:20,  5.04s/it]

 38%|###7      | 9/24 [00:45&lt;01:15,  5.05s/it]

 42%|####1     | 10/24 [00:50&lt;01:10,  5.07s/it]

 46%|####5     | 11/24 [00:55&lt;01:05,  5.07s/it]

 50%|#####     | 12/24 [01:00&lt;01:00,  5.05s/it]

 54%|#####4    | 13/24 [01:05&lt;00:55,  5.04s/it]

 58%|#####8    | 14/24 [01:10&lt;00:50,  5.07s/it]

 62%|######2   | 15/24 [01:15&lt;00:45,  5.10s/it]

 67%|######6   | 16/24 [01:20&lt;00:40,  5.12s/it]

 71%|#######   | 17/24 [01:25&lt;00:35,  5.13s/it]

 75%|#######5  | 18/24 [01:31&lt;00:30,  5.14s/it]

 79%|#######9  | 19/24 [01:36&lt;00:25,  5.16s/it]

 83%|########3 | 20/24 [01:41&lt;00:20,  5.15s/it]

 88%|########7 | 21/24 [01:46&lt;00:15,  5.10s/it]

 92%|#########1| 22/24 [01:51&lt;00:10,  5.12s/it]

 96%|#########5| 23/24 [01:56&lt;00:05,  5.09s/it]

100%|##########| 24/24 [02:01&lt;00:00,  5.03s/it]
100%|##########| 24/24 [02:01&lt;00:00,  5.06s/it]

 50%|#####     | 1/2 [02:02&lt;02:02, 122.36s/it]

  0%|          | 0/24 [00:00&lt;?, ?it/s]

  4%|4         | 1/24 [00:04&lt;01:52,  4.88s/it]

  8%|8         | 2/24 [00:09&lt;01:47,  4.88s/it]

 12%|#2        | 3/24 [00:14&lt;01:41,  4.85s/it]

 17%|#6        | 4/24 [00:19&lt;01:37,  4.87s/it]

 21%|##        | 5/24 [00:24&lt;01:32,  4.89s/it]

 25%|##5       | 6/24 [00:29&lt;01:27,  4.89s/it]

 29%|##9       | 7/24 [00:34&lt;01:24,  4.96s/it]

 33%|###3      | 8/24 [00:39&lt;01:20,  5.01s/it]

 38%|###7      | 9/24 [00:44&lt;01:14,  4.99s/it]

 42%|####1     | 10/24 [00:49&lt;01:10,  5.04s/it]

 46%|####5     | 11/24 [00:54&lt;01:05,  5.06s/it]

 50%|#####     | 12/24 [00:59&lt;01:00,  5.07s/it]

 54%|#####4    | 13/24 [01:04&lt;00:54,  4.98s/it]

 58%|#####8    | 14/24 [01:09&lt;00:49,  4.94s/it]

 62%|######2   | 15/24 [01:14&lt;00:44,  4.97s/it]

 67%|######6   | 16/24 [01:19&lt;00:39,  5.00s/it]

 71%|#######   | 17/24 [01:24&lt;00:34,  4.97s/it]

 75%|#######5  | 18/24 [01:29&lt;00:29,  4.93s/it]

 79%|#######9  | 19/24 [01:34&lt;00:24,  4.92s/it]

 83%|########3 | 20/24 [01:39&lt;00:19,  4.90s/it]

 88%|########7 | 21/24 [01:43&lt;00:14,  4.90s/it]

 92%|#########1| 22/24 [01:48&lt;00:09,  4.90s/it]

 96%|#########5| 23/24 [01:53&lt;00:04,  4.91s/it]

100%|##########| 24/24 [01:58&lt;00:00,  4.90s/it]
100%|##########| 24/24 [01:58&lt;00:00,  4.94s/it]

100%|##########| 2/2 [04:01&lt;00:00, 120.67s/it]
100%|##########| 2/2 [04:01&lt;00:00, 120.93s/it]
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 8 minutes  45.792 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-hbn-site-profiles-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/4089326b1079478b20ded0a482f170dd/plot_hbn_site_profiles.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_hbn_site_profiles.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/59b2ef974e8631cfc6f5cd750f2eebbd/plot_hbn_site_profiles.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_hbn_site_profiles.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="demo_afq_dataset.html" class="btn btn-neutral float-left" title="Load and interact with an AFQ dataset" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="plot_age_regression.html" class="btn btn-neutral float-right" title="Predict age from white matter features" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Adam Richie-Halford.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>